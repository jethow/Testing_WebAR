<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Face Hat Filter</title>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <!-- MediaPipe Face Mesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    video {
      position: absolute;
      top: 0;
      left: 0;
      transform: scaleX(-1);
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <!-- Camera -->
  <video id="video" autoplay muted playsinline></video>

  <script>
    // ====== THREE.JS SETUP ======
    const scene = new THREE.Scene();

    const camera3D = new THREE.PerspectiveCamera(
      45,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera3D.position.z = 5;

    const renderer = new THREE.WebGLRenderer({ alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // ====== HAT IMAGE ======
    const textureLoader = new THREE.TextureLoader();
    const hatTexture = textureLoader.load("hat.png");

    const hatMaterial = new THREE.MeshBasicMaterial({
      map: hatTexture,
      transparent: true
    });

    const hatGeometry = new THREE.PlaneGeometry(2, 1.2);
    const hat = new THREE.Mesh(hatGeometry, hatMaterial);
    scene.add(hat);

    // ====== MEDIAPIPE FACE MESH ======
    const video = document.getElementById("video");

    const faceMesh = new FaceMesh({
      locateFile: file =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    faceMesh.onResults(onResults);

    const cameraMP = new Camera(video, {
      onFrame: async () => {
        await faceMesh.send({ image: video });
      },
      width: 640,
      height: 480
    });
    cameraMP.start();

    // ====== FACE TRACKING LOGIC ======
    function onResults(results) {
      if (!results.multiFaceLandmarks.length) {
        hat.visible = false;
        return;
      }

      hat.visible = true;

      const landmarks = results.multiFaceLandmarks[0];

      // Forehead landmarks
      const left = landmarks[234];
      const right = landmarks[454];
      const top = landmarks[10];

      const x = (left.x + right.x) / 2 - 0.5;
      const y = -(top.y - 0.5);

      hat.position.set(x * 6, y * 4 + 1.2, 0);

      const faceWidth = Math.abs(right.x - left.x);
      hat.scale.set(faceWidth * 10, faceWidth * 5, 1);
    }

    // ====== RENDER LOOP ======
    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera3D);
    }
    animate();

    // ====== RESIZE ======
    window.addEventListener("resize", () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera3D.aspect = window.innerWidth / window.innerHeight;
      camera3D.updateProjectionMatrix();
    });
  </script>
</body>
</html>
