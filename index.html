<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Face 2D Hat Filter</title>
  <style>
    body { margin:0; overflow:hidden; }
    video { 
      position:absolute; top:0; left:0; width:100%; transform: scaleX(-1); 
    }
    canvas { position:absolute; top:0; left:0; pointer-events:none; }
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<script type="module">
  // ===== Imports =====
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
  import { FaceMesh } from 'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js';
  import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

  // ===== Setup video + canvas =====
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const MAX_HATS = 5;
  const hatImg = new Image();
  hatImg.src = 'hat.png'; // Make sure hat.png is in the same folder

  // ===== MediaPipe FaceMesh =====
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });
  faceMesh.setOptions({
    maxNumFaces: MAX_HATS,
    refineLandmarks:true,
    minDetectionConfidence:0.5,
    minTrackingConfidence:0.5
  });

  faceMesh.onResults(results => {
    // Clear canvas
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.scale(-1,1); // mirror horizontally
    ctx.translate(-canvas.width,0);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    if(results.multiFaceLandmarks){
      results.multiFaceLandmarks.forEach(landmarks=>{
        const leftEye = landmarks[33];
        const rightEye = landmarks[263];
        const topForehead = landmarks[10];

        const x = (leftEye.x + rightEye.x)/2;
        const y = topForehead.y;

        const width = Math.abs(rightEye.x - leftEye.x)*canvas.width*2;
        const height = width * 0.8;

        ctx.drawImage(hatImg, x*canvas.width - width/2, y*canvas.height - height*1.1, width, height);
      });
    }

    ctx.restore();
  });

  // ===== Start camera =====
  const cameraMP = new Camera(video,{
    onFrame: async()=>{ await faceMesh.send({image:video}); },
    width:640,
    height:480
  });
  cameraMP.start();

  // ===== Resize =====
  window.addEventListener('resize',()=>{
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  });
</script>

</body>
</html>
