<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Hat AR with Camera Prompt</title>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
body { margin:0; overflow:hidden; background:#000; display:flex; align-items:center; justify-content:center; }
video, canvas { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scaleX(-1); object-fit:contain; }
button { z-index:10; padding:10px 20px; font-size:16px; }
</style>
</head>
<body>

<button id="startBtn">Start Camera</button>
<video id="video" autoplay muted playsinline></video>

<script>
const video = document.getElementById("video");
const startBtn = document.getElementById("startBtn");

// THREE.JS setup
const scene = new THREE.Scene();
const camera3D = new THREE.PerspectiveCamera(45,1,0.1,1000);
camera3D.position.z=5;
const renderer = new THREE.WebGLRenderer({alpha:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.domElement.style.position="absolute";
renderer.domElement.style.top="50%";
renderer.domElement.style.left="50%";
renderer.domElement.style.transform="translate(-50%, -50%)";
document.body.appendChild(renderer.domElement);

// Load hats
const MAX_HATS=5;
const hats=[];
const loader = new THREE.GLTFLoader();
loader.load("hat.glb", gltf=>{
    const baseHat = gltf.scene;
    for(let i=0;i<MAX_HATS;i++){
        const hat = baseHat.clone();
        hat.visible=false;
        scene.add(hat);
        hats.push(hat);
    }
});

// MediaPipe
const faceMesh = new FaceMesh({ locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
faceMesh.setOptions({ maxNumFaces:MAX_HATS, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });
faceMesh.onResults(onResults);

// Animate loop
function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera3D); }
animate();

// Position hats
function onResults(results){
    if(!results.multiFaceLandmarks){ hats.forEach(h=>h.visible=false); return; }
    hats.forEach(h=>h.visible=false);
    results.multiFaceLandmarks.forEach((landmarks,index)=>{
        if(index>=hats.length) return;
        const hat = hats[index];
        hat.visible=true;
        const leftEye=landmarks[33];
        const rightEye=landmarks[263];
        const forehead=landmarks[10];
        const x = 0.5 - (leftEye.x + rightEye.x)/2; // flip for selfie
        const y = -(forehead.y - 0.5);
        hat.position.set(x*6, y*4+0.2, 0);
        const faceWidth=Math.abs(rightEye.x-leftEye.x);
        hat.scale.set(faceWidth*4, faceWidth*4, faceWidth*4);
    });
}

// Resize handler
function resizeHandler(){
    const videoAspect=video.videoWidth/video.videoHeight || 640/480;
    const windowAspect=window.innerWidth/window.innerHeight;
    let width,height;
    if(windowAspect>videoAspect){ height=window.innerHeight; width=height*videoAspect; }
    else{ width=window.innerWidth; height=width/videoAspect; }
    video.style.width=width+"px";
    video.style.height=height+"px";
    renderer.setSize(width,height);
    camera3D.aspect=width/height;
    camera3D.updateProjectionMatrix();
}
window.addEventListener("resize",resizeHandler);

// ===== Start Camera Button =====
startBtn.addEventListener("click", async()=>{
    startBtn.style.display="none";
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
        video.srcObject = stream;

        const cameraMP = new Camera(video,{
            onFrame: async()=>{ await faceMesh.send({image:video}); },
            width: video.videoWidth || 640,
            height: video.videoHeight || 480,
            facingMode:"user"
        });
        cameraMP.start();

        video.addEventListener("loadedmetadata", resizeHandler);
    }catch(e){ alert("Camera permission denied or error: "+e); }
});
</script>

</body>
</html>
