<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multi-Face 3D Hat Filter</title>

<!-- Three.js -->
<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

<!-- MediaPipe Face Mesh -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #000;
  }

  video, canvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scaleX(-1); /* mirror horizontally */
    object-fit: none; /* keep native aspect ratio, no stretch */
    width: auto;
    height: auto;
  }
</style>
</head>

<body>
<video id="video" autoplay muted playsinline></video>

<script>
(async function() {
  const video = document.getElementById("video");

  // ===== THREE.JS SETUP =====
  const scene = new THREE.Scene();
  const camera3D = new THREE.PerspectiveCamera(45,1,0.1,1000);
  camera3D.position.z = 5;

  const renderer = new THREE.WebGLRenderer({ alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.position = "absolute";
  renderer.domElement.style.top = "50%";
  renderer.domElement.style.left = "50%";
  renderer.domElement.style.transform = "translate(-50%, -50%)";
  document.body.appendChild(renderer.domElement);

  // ===== LOAD 3D HATS =====
  const MAX_HATS = 5;
  const hats = [];
  const loader = new THREE.GLTFLoader();
  loader.load("hat.glb", gltf => {
    const baseHat = gltf.scene;
    for (let i=0; i<MAX_HATS; i++){
      const hat = baseHat.clone();
      hat.visible = false;
      scene.add(hat);
      hats.push(hat);
    }
  });

  // ===== MEDIA PIPE FACE MESH =====
  const faceMesh = new FaceMesh({
    locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });
  faceMesh.setOptions({
    maxNumFaces: MAX_HATS,
    refineLandmarks:true,
    minDetectionConfidence:0.5,
    minTrackingConfidence:0.5
  });
  faceMesh.onResults(onResults);

  // ===== START CAMERA =====
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      video.play();

      const cameraMP = new Camera(video, {
        onFrame: async()=>{ await faceMesh.send({ image: video }); },
        width: video.videoWidth,
        height: video.videoHeight,
        facingMode:"user"
      });
      cameraMP.start();

      resizeHandler();
    };
  } catch(e){ console.error("Camera error:", e); }

  // ===== POSITION HATS =====
  function onResults(results){
    if(!results.multiFaceLandmarks){
      hats.forEach(h=>h.visible=false);
      return;
    }

    hats.forEach(h=>h.visible=false);

    results.multiFaceLandmarks.forEach((landmarks,index)=>{
      if(index>=hats.length) return;

      const hat = hats[index];
      hat.visible = true;

      const leftEye = landmarks[33];
      const rightEye = landmarks[263];
      const forehead = landmarks[10];

      // Flip X for selfie video
      const x = 0.5 - (leftEye.x + rightEye.x)/2;
      const y = -(forehead.y - 0.5);

      hat.position.set(x*6, y*4 + 0.2, 0);

      const faceWidth = Math.abs(rightEye.x - leftEye.x);
      hat.scale.set(faceWidth*4, faceWidth*4, faceWidth*4);
    });
  }

  // ===== RENDER LOOP =====
  function animate(){
    requestAnimationFrame(animate);
    renderer.render(scene, camera3D);
  }
  animate();

  // ===== RESIZE =====
  function resizeHandler(){
    if(!video.videoWidth) return;

    const videoAspect = video.videoWidth/video.videoHeight;
    const windowAspect = window.innerWidth/window.innerHeight;
    let width, height;

    if(windowAspect > videoAspect){
      // Window is wider → full height
      height = window.innerHeight;
      width = height * videoAspect;
    } else {
      // Window is taller → full width
      width = window.innerWidth;
      height = width / videoAspect;
    }

    video.style.width = width + "px";
    video.style.height = height + "px";

    renderer.setSize(width, height);
    camera3D.aspect = width/height;
    camera3D.updateProjectionMatrix();
  }

  window.addEventListener("resize", resizeHandler);
})();
</script>
</body>
</html>
