<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi-Face 3D Hat Filter</title>
  <style>
    body { margin: 0; overflow: hidden; }
    video { position: absolute; top:0; left:0; width:100%; transform: scaleX(-1); }
    canvas { position: absolute; top:0; left:0; pointer-events:none; }
  </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>

<script type="module">
  // ===== Import Three.js and GLTFLoader via URL =====
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

  // ===== Three.js Scene Setup =====
  const scene = new THREE.Scene();
  const camera3D = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera3D.position.z = 5;

  const renderer = new THREE.WebGLRenderer({ alpha:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // ===== Hats array for multi-face =====
  const hats = [];
  const MAX_HATS = 5;

  const loader = new GLTFLoader();
  loader.load('hat.glb', gltf => {
    for(let i=0; i<MAX_HATS; i++){
      const hat = gltf.scene.clone();
      hat.scale.set(1,1,1);
      hat.visible = false;
      scene.add(hat);
      hats.push(hat);
    }
  });

  // ===== MediaPipe FaceMesh =====
  import { FaceMesh } from 'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js';
  import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

  const video = document.getElementById('video');
  const faceMesh = new FaceMesh({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });

  faceMesh.setOptions({
    maxNumFaces: MAX_HATS,
    refineLandmarks:true,
    minDetectionConfidence:0.5,
    minTrackingConfidence:0.5
  });

  faceMesh.onResults(results => {
    if(!results.multiFaceLandmarks){
      hats.forEach(h=>h.visible=false);
      return;
    }

    hats.forEach(h=>h.visible=false);

    results.multiFaceLandmarks.forEach((landmarks,index)=>{
      if(index>=hats.length) return;
      const hat = hats[index];
      hat.visible = true;

      const leftEye = landmarks[33];
      const rightEye = landmarks[263];
      const topForehead = landmarks[10];

      const x = (leftEye.x + rightEye.x)/2 - 0.5;
      const y = -(topForehead.y - 0.5);

      hat.position.set(x*6, y*4 + 0.8, 0);

      const faceWidth = Math.abs(rightEye.x - leftEye.x);
      hat.scale.set(faceWidth*4, faceWidth*4, faceWidth*4);
    });
  });

  const cameraMP = new Camera(video,{
    onFrame: async()=>{ await faceMesh.send({image:video}); },
    width:640, height:480
  });
  cameraMP.start();

  // ===== Render loop =====
  function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera3D);}
  animate();

  window.addEventListener('resize',()=>{
    renderer.setSize(window.innerWidth,window.innerHeight);
    camera3D.aspect=window.innerWidth/window.innerHeight;
    camera3D.updateProjectionMatrix();
  });
</script>

</body>
</html>
